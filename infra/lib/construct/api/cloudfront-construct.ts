import { Construct } from 'constructs';
import * as cloudfront from 'aws-cdk-lib/aws-cloudfront';
import * as s3 from 'aws-cdk-lib/aws-s3';
import * as origins from 'aws-cdk-lib/aws-cloudfront-origins';

export interface CloudFrontConstructProps {
  /**
   * オリジンとなるS3バケット
   */
  originBucket: s3.IBucket;
  /**
   * コメント
   */
  comment?: string;
  /**
   * デフォルトルートオブジェクト
   * @default 'index.html'
   */
  defaultRootObject?: string;
  /**
   * エラーレスポンス設定（SPA対応）
   * @default true
   */
  spaMode?: boolean;
}

/**
 * レイヤー1: CloudFront DistributionConstruct（単一リソース）
 * 
 * 責務: 単一のCloudFront Distributionをセキュアなデフォルト設定で抽象化
 * - S3オリジンとの統合
 * - SPA対応のエラーハンドリング
 * 
 * 変更頻度: ほぼなし（AWSベストプラクティスの更新時のみ）
 */
export class CloudFrontConstruct extends Construct {
  public readonly distribution: cloudfront.Distribution;

  constructor(scope: Construct, id: string, props: CloudFrontConstructProps) {
    super(scope, id);

    // CloudFront Distribution（L2コンストラクト）
    this.distribution = new cloudfront.Distribution(this, 'Distribution', {
      defaultBehavior: {
        origin: new origins.S3Origin(props.originBucket),
        viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,
        cachePolicy: cloudfront.CachePolicy.CACHING_OPTIMIZED,
      },
      defaultRootObject: props.defaultRootObject || 'index.html',
      errorResponses: props.spaMode !== false
        ? [
            {
              httpStatus: 403,
              responseHttpStatus: 200,
              responsePagePath: '/index.html',
            },
            {
              httpStatus: 404,
              responseHttpStatus: 200,
              responsePagePath: '/index.html',
            },
          ]
        : undefined,
      comment: props.comment || 'CloudFront Distribution',
    });
  }
}

