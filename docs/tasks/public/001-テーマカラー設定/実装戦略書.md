# テーマカラー設定 - 実装戦略書

## 概要

ユーザーがアプリのテーマカラー（プリセット）とライト/ダークモードを選択できる機能を実装する。

## 要件

- **プリセット方式**: 事前定義されたカラーテーマから選択
- **ダークモード対応**: ライト/ダーク/システム設定の3モード
- **永続化**: localStorage で保存（デバイス間同期なし）
- **即時反映**: 選択と同時にUIに反映
- **SSR対応**: チラつき（FOUC）を防止

---

## ベースカラー

| ID | 名前 | HEX | HSL |
|----|------|-----|-----|
| purple | パープル | #655395 | 256 29% 45% |
| red | レッド | #d5697e | 350 55% 62% |
| yellow | イエロー | #b59235 | 44 55% 46% |
| blue | ブルー | #3f77a4 | 207 44% 45% |
| green | グリーン | #698f75 | 139 16% 49% |

---

## CSS変数の調整戦略

### 調整対象の変数

shadcn/ui では多くのCSS変数が定義されています。プリセット変更時に調整が必要な変数を整理します。

| 変数 | 役割 | 調整方法 |
|------|------|----------|
| `--primary` | メインカラー（ボタン、ヘッダー等） | プリセットのベースカラー |
| `--primary-foreground` | primary上のテキスト | 常に白 `0 0% 100%` |
| `--ring` | フォーカスリング | primaryと同じ |
| `--accent` | アクセント（ホバー背景等） | primaryを薄くした色 |
| `--accent-foreground` | accent上のテキスト | 変更なし（既存値維持） |

### 調整しない変数

| 変数 | 理由 |
|------|------|
| `--background` | ライト/ダークで固定。テーマカラーに依存しない |
| `--foreground` | テキスト色は固定 |
| `--card`, `--popover` | 背景系は固定 |
| `--muted` | 中間色は固定 |
| `--border`, `--input` | 境界線は固定 |
| `--destructive` | 削除・エラー色は固定（赤系） |
| `--secondary` | セカンダリは固定（グレー系） |

### accent の計算方法

```
Light mode: primaryのLightness を 95% に上げた薄い色
Dark mode:  primaryのLightness を 20% に下げた濃い色
```

例（red プリセット）:
- primary: `350 55% 62%`
- accent (light): `350 55% 95%` → 薄いピンク
- accent (dark): `350 55% 20%` → 濃いワイン色

---

## 技術設計

### 1. データ構造

```typescript
// features/theme/model/types.ts

export type ThemeMode = 'light' | 'dark' | 'system';

export type ThemePresetId = 'purple' | 'red' | 'yellow' | 'blue' | 'green';

export interface ThemePresetColors {
  primary: string;           // HSL値
  ring: string;              // = primary
  accentLight: string;       // Light mode用 accent
  accentDark: string;        // Dark mode用 accent
}

export interface ThemePreset {
  id: ThemePresetId;
  name: string;
  hex: string;               // プレビュー用
  colors: ThemePresetColors;
}

export interface ThemeSettings {
  presetId: ThemePresetId;
  mode: ThemeMode;
}
```

### 2. プリセット定義

```typescript
// features/theme/lib/theme-presets.ts

export const themePresets: Record<ThemePresetId, ThemePreset> = {
  purple: {
    id: 'purple',
    name: 'パープル',
    hex: '#655395',
    colors: {
      primary: '256 29% 45%',
      ring: '256 29% 45%',
      accentLight: '256 29% 95%',
      accentDark: '256 29% 20%',
    },
  },
  red: {
    id: 'red',
    name: 'レッド',
    hex: '#d5697e',
    colors: {
      primary: '350 55% 62%',
      ring: '350 55% 62%',
      accentLight: '350 55% 95%',
      accentDark: '350 55% 20%',
    },
  },
  yellow: {
    id: 'yellow',
    name: 'イエロー',
    hex: '#b59235',
    colors: {
      primary: '44 55% 46%',
      ring: '44 55% 46%',
      accentLight: '44 55% 95%',
      accentDark: '44 55% 20%',
    },
  },
  blue: {
    id: 'blue',
    name: 'ブルー',
    hex: '#3f77a4',
    colors: {
      primary: '207 44% 45%',
      ring: '207 44% 45%',
      accentLight: '207 44% 95%',
      accentDark: '207 44% 20%',
    },
  },
  green: {
    id: 'green',
    name: 'グリーン',
    hex: '#698f75',
    colors: {
      primary: '139 16% 49%',
      ring: '139 16% 49%',
      accentLight: '139 16% 95%',
      accentDark: '139 16% 20%',
    },
  },
};

export const defaultThemeSettings: ThemeSettings = {
  presetId: 'red',
  mode: 'system',
};
```

### 3. ストレージキー

```typescript
// features/theme/lib/theme-storage.ts

const THEME_STORAGE_KEY = 'ghoona-theme';
```

### 4. 既存 storage.ts の活用

```typescript
import { localStorage } from '@/shared/utils/storage/storage';

export function getStoredTheme(): ThemeSettings | null {
  return localStorage?.get<ThemeSettings>(THEME_STORAGE_KEY) ?? null;
}

export function setStoredTheme(settings: ThemeSettings): void {
  localStorage?.set(THEME_STORAGE_KEY, settings);
}
```

---

## 実装方針

### Phase 1: テーマ基盤

1. **型定義・プリセット定義**
   - `features/theme/model/types.ts`
   - `features/theme/lib/theme-presets.ts`

2. **ストレージ層**
   - `features/theme/lib/theme-storage.ts`
   - 既存の `shared/utils/storage/storage.ts` を活用

3. **テーマ適用ロジック**
   - `features/theme/lib/theme-applier.ts`
   - CSS変数の動的更新
   - ダークモードクラスの切り替え

### Phase 2: Context & Provider

4. **ThemeContext**
   - `features/theme/lib/theme-context.tsx`
   - 現在のテーマ状態を管理
   - テーマ変更関数を提供

5. **ThemeProvider**
   - `app/providers.tsx` に統合
   - 初期化時にlocalStorageから読み込み

### Phase 3: SSR対策（FOUC防止）

6. **初期化スクリプト**
   - `app/layout.tsx` に `<script>` を追加
   - ハイドレーション前にテーマを適用

```tsx
// layout.tsx
<script
  dangerouslySetInnerHTML={{
    __html: `
      (function() {
        try {
          const stored = localStorage.getItem('ghoona-theme');
          if (stored) {
            const { presetId, mode } = JSON.parse(stored);
            const presets = ${JSON.stringify(themePresets)};
            const preset = presets[presetId];
            if (preset) {
              document.documentElement.style.setProperty('--primary', preset.primary);
              document.documentElement.style.setProperty('--ring', preset.ring);
            }
            const isDark = mode === 'dark' ||
              (mode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDark) {
              document.documentElement.classList.add('dark');
            }
          }
        } catch (e) {}
      })()
    `,
  }}
/>
```

### Phase 4: 設定UI

7. **ThemePicker コンポーネント**
   - `features/theme/ui/ThemePicker.tsx`
   - プリセット選択（カラーサークル）
   - モード切り替え（ライト/ダーク/システム）

8. **設定ページ統合**
   - `/settings/account` または専用ページに配置

---

## ディレクトリ構成

```
frontend/src/
├── features/
│   └── core/
│       └── theme/
│       ├── model/
│       │   └── types.ts              # 型定義
│       ├── lib/
│       │   ├── theme-presets.ts      # プリセット定義
│       │   ├── theme-storage.ts      # localStorage操作
│       │   ├── theme-applier.ts      # CSS変数適用ロジック
│       │   └── theme-context.tsx     # Context & Provider
│       └── ui/
│           ├── ThemePicker.tsx       # テーマ選択UI
│           ├── ColorPresetButton.tsx # プリセット選択ボタン
│           └── ModeToggle.tsx        # ライト/ダーク切り替え
├── page-components/
│   └── settings/
│       └── account/
│           └── ui/
│               └── AccountSettingsContainer.tsx  # 設定ページ（テーマのみ）
├── app/
│   ├── (authenticated)/
│   │   └── settings/
│   │       └── account/
│   │           └── page.tsx          # 設定ページルート
│   ├── layout.tsx                    # 初期化スクリプト追加
│   └── providers.tsx                 # ThemeProvider統合
└── shared/
    └── utils/
        └── storage/
            └── storage.ts            # 既存（そのまま活用）
```

---

## CSS変数の更新対象

| 変数名 | 用途 | 動的更新 | 備考 |
|--------|------|----------|------|
| `--primary` | メインカラー | Yes | プリセットのベースカラー |
| `--ring` | フォーカスリング | Yes | = primary |
| `--accent` | ホバー背景等 | Yes | Light/Darkで異なる値 |
| `--primary-foreground` | プライマリ上のテキスト | No | 常に白 `0 0% 100%` |
| `--accent-foreground` | アクセント上のテキスト | No | 既存値維持 |

### テーマ適用ロジック

```typescript
// features/theme/lib/theme-applier.ts

export function applyTheme(preset: ThemePreset, isDark: boolean): void {
  const root = document.documentElement;
  const { colors } = preset;

  // 共通
  root.style.setProperty('--primary', colors.primary);
  root.style.setProperty('--ring', colors.ring);

  // モード別
  root.style.setProperty('--accent', isDark ? colors.accentDark : colors.accentLight);

  // ダークモードクラス
  if (isDark) {
    root.classList.add('dark');
  } else {
    root.classList.remove('dark');
  }
}
```

※ ダークモードは `html` 要素に `.dark` クラスを付与することで切り替え（Tailwind標準方式）

---

## 考慮事項

### パフォーマンス
- CSS変数の更新は軽量（再レンダリング不要）
- localStorage の読み書きは同期的だが十分高速

### アクセシビリティ
- システム設定の尊重（prefers-color-scheme）
- コントラスト比の確保（プリセットで保証）

### 将来の拡張性
- カスタムカラー対応（将来）
- テーマのDB同期（将来）
- アクセントカラーの追加（将来）

---

## 実装順序

1. `features/theme/model/types.ts` - 型定義
2. `features/theme/lib/theme-presets.ts` - プリセット定義
3. `features/theme/lib/theme-storage.ts` - localStorage操作
4. `features/theme/lib/theme-applier.ts` - CSS変数適用ロジック
5. `features/theme/lib/theme-context.tsx` - Context & Provider
6. `app/layout.tsx` の更新（初期化スクリプト）
7. `app/providers.tsx` の更新（ThemeProvider統合）
8. `features/theme/ui/ColorPresetButton.tsx` - プリセット選択ボタン
9. `features/theme/ui/ModeToggle.tsx` - モード切り替え
10. `features/theme/ui/ThemePicker.tsx` - メインUI
11. `page-components/settings/account/ui/AccountSettingsContainer.tsx` - 設定ページ
12. `app/(authenticated)/settings/account/page.tsx` - ルート定義
