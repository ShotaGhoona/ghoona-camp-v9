# テーマカラー設定 - 影響範囲ツリー

## ファイル影響マップ

```
テーマカラー設定
│
├─ 【新規作成】features/core/theme/
│   │
│   ├─ model/
│   │   └─ types.ts                    [新規] 型定義
│   │
│   ├─ lib/
│   │   ├─ theme-presets.ts            [新規] プリセット定義
│   │   ├─ theme-storage.ts            [新規] localStorage操作
│   │   ├─ theme-applier.ts            [新規] CSS変数適用
│   │   └─ theme-context.tsx           [新規] Context & Provider & Hook
│   │
│   └─ ui/
│       ├─ ThemePicker.tsx             [新規] テーマ選択UI
│       ├─ ColorPresetButton.tsx       [新規] プリセットボタン
│       └─ ModeToggle.tsx              [新規] モード切り替え
│
├─ 【変更】app/
│   │
│   ├─ layout.tsx                      [変更] 初期化スクリプト追加
│   │   └─ 変更内容:
│   │       - <script> タグで初期テーマ適用
│   │       - FOUC防止のための即時実行
│   │
│   ├─ providers.tsx                   [変更] ThemeProvider追加
│   │   └─ 変更内容:
│   │       - ThemeProviderをインポート
│   │       - Provider階層に追加
│   │
│   └─ globals.css                     [変更なし]
│       └─ 既存のCSS変数定義をそのまま活用
│           - :root と .dark の定義済み
│           - --primary, --ring 等
│
├─ 【参照】shared/
│   │
│   └─ utils/storage/storage.ts        [変更なし・参照のみ]
│       └─ 既存のlocalStorageラッパーを活用
│
├─ 【影響を受ける】widgets/
│   │
│   └─ common/layout/header/ui/
│       └─ AppHeader.tsx               [変更なし]
│           └─ 既に bg-primary, text-primary-foreground を使用
│               → CSS変数の変更で自動的に反映される
│
├─ 【新規作成】page-components/
│   │
│   └─ settings/
│       └─ account/
│           └─ ui/
│               └─ AccountSettingsContainer.tsx  [新規]
│                   └─ ThemePicker を配置（テーマカラー設定のみ）
│
└─ 【新規作成】app/(authenticated)/settings/
    │
    └─ account/
        └─ page.tsx                    [新規]
            └─ AccountSettingsContainer を呼び出し
```

---

## 依存関係

```
ThemePicker (UI)
    │
    └─ uses ─→ theme-context (useTheme hook)
                    │
                    ├─ uses ─→ theme-storage (localStorage)
                    │               │
                    │               └─ uses ─→ shared/utils/storage/storage.ts
                    │
                    └─ uses ─→ theme-applier (CSS変数更新)
                                    │
                                    └─ uses ─→ theme-presets (プリセット定義)
```

---

## 変更ファイル一覧

### 新規作成 (11ファイル)

| ファイルパス | 役割 |
|-------------|------|
| `features/theme/model/types.ts` | 型定義 |
| `features/theme/lib/theme-presets.ts` | プリセット定義 |
| `features/theme/lib/theme-storage.ts` | localStorage操作 |
| `features/theme/lib/theme-applier.ts` | CSS変数適用ロジック |
| `features/theme/lib/theme-context.tsx` | Context, Provider, useTheme |
| `features/theme/ui/ThemePicker.tsx` | メインUI |
| `features/theme/ui/ColorPresetButton.tsx` | プリセット選択ボタン |
| `features/theme/ui/ModeToggle.tsx` | ライト/ダーク切り替え |
| `page-components/settings/account/ui/AccountSettingsContainer.tsx` | 設定ページコンテナ |
| `app/(authenticated)/settings/account/page.tsx` | 設定ページルート |

### 変更 (2ファイル)

| ファイルパス | 変更内容 |
|-------------|----------|
| `app/layout.tsx` | 初期化スクリプト追加 |
| `app/providers.tsx` | ThemeProvider追加 |

### 変更なし・参照のみ (2ファイル)

| ファイルパス | 備考 |
|-------------|------|
| `shared/utils/storage/storage.ts` | 既存を活用 |
| `app/globals.css` | CSS変数定義済み |

---

## 自動的に影響を受けるコンポーネント

CSS変数 (`--primary`, `--ring`, `--accent`) を使用している全コンポーネントは、テーマ変更時に自動的に色が変わる。

### 動的に変更されるCSS変数

| 変数 | 用途 | プリセット依存 | モード依存 |
|------|------|---------------|-----------|
| `--primary` | メインカラー | Yes | No |
| `--ring` | フォーカスリング | Yes | No |
| `--accent` | ホバー背景等 | Yes | Yes（Light/Darkで異なる） |

### 現在確認済み

| コンポーネント | 使用箇所 |
|---------------|----------|
| `AppHeader.tsx` | `bg-primary`, `text-primary-foreground` |
| shadcn/ui Button | `bg-primary` (variant="default") |
| shadcn/ui Button | `bg-accent` (variant="ghost" hover時) |
| shadcn/ui Input | `ring-ring` (フォーカス時) |
| shadcn/ui DropdownMenuItem | `bg-accent` (ホバー時) |

### 将来的に影響

- 全ての `bg-primary`, `text-primary`, `border-primary` を使用するコンポーネント
- 全ての `bg-accent`, `text-accent` を使用するコンポーネント
- フォーカスリングを使用するフォーム要素

---

## ダークモード影響範囲

`.dark` クラスが `<html>` に付与されると、以下のCSS変数が切り替わる：

### globals.css で定義済み（固定値）

| 変数 | Light | Dark |
|------|-------|------|
| `--background` | 白 | 濃紺 |
| `--foreground` | 濃紺 | 白 |
| `--card` | 白 | 濃紺 |
| `--popover` | 白 | 濃紺 |
| `--muted` | 薄グレー | 濃グレー |
| `--border` | 薄グレー | 濃グレー |

### JavaScript で動的に設定（プリセット依存）

| 変数 | Light | Dark |
|------|-------|------|
| `--primary` | プリセットのベースカラー | 同左 |
| `--ring` | = primary | 同左 |
| `--accent` | primaryの薄い版（L=95%） | primaryの濃い版（L=20%） |

※ `--primary` はライト/ダーク共通。`--accent` のみモードで切り替え

---

## リスク評価

| リスク | 影響度 | 対策 |
|--------|--------|------|
| FOUC (チラつき) | 中 | layout.tsx での即時スクリプト実行 |
| SSR不整合 | 低 | useEffect 内でのみ状態更新 |
| localStorage 未対応ブラウザ | 極低 | storage.ts で try-catch 済み |
| プリセット追加時の影響 | 低 | theme-presets.ts のみ変更 |

---

## テスト観点

1. **プリセット切り替え**
   - 全5色（purple, red, yellow, blue, green）が正しく適用されるか
   - AppHeader の色が変わるか
   - DropdownMenu のホバー色（accent）が変わるか
   - フォーカスリングの色が変わるか

2. **ダークモード**
   - ライト→ダーク切り替え
   - システム設定追従（mode='system'）
   - リロード後の復元
   - accent がモードに応じて切り替わるか

3. **永続化**
   - localStorage への保存
   - 別タブでの同期（storage イベント）
   - リロード後にテーマが維持されるか

4. **SSR/FOUC**
   - 初回ロード時のチラつきなし
   - ハイドレーションエラーなし
   - サーバー/クライアント間の不整合なし

5. **プリセット別テスト**

   | プリセット | HEX | 確認ポイント |
   |-----------|-----|-------------|
   | purple | #655395 | 落ち着いた紫 |
   | red | #d5697e | デフォルト。現在のヘッダー色 |
   | yellow | #b59235 | マスタード系。視認性確認 |
   | blue | #3f77a4 | 落ち着いた青 |
   | green | #698f75 | セージグリーン系 |
