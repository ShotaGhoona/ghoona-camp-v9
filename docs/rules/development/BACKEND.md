# バックエンド 開発ガイド

## 目次

1. [はじめに](#はじめに)
2. [DB について]
3. [API について]
4. [実装済み機能について]

---

## はじめに

このガイドでは、AI Solution Template を使った実践的な開発方法を説明します。

### 前提

- [BACKEND_ARCHITECTURE.md](./BACKEND_ARCHITECTURE.md) で DDD に基づくオニオンアーキテクチャを理解ずみ
- python, Postgres(MySQL)の基礎知識がある
- 開発案件における、DB 設計・API 設計が完了している。

---

## DB について

- DB 設計が完了したのちは、実際にバックエンドのコードに書き起こして行く作業が必要になります。

### 手順

1. `app/infrastructure/db/models/`内に必要なテーブルを記述していきます。
   - 例をコメントアウトで書いているので参考にしてください。
   - index などの細かい設定もここで記述しておくべきですが、初めは特に書かず、後からパフォーマンス改善のために必要になるたびに追加していくという方法を取ってもいいと思います。
2. `app/infrastructure/db/models/__init__.py`を作成し、そこに 1. で記述したモデルを全てインポートします。
3. `backend/alembic/env.py`の l.29 以下に全てのモデルをインポートしておきます。
   - こうすることで、alembic が自動で差分を検出してくれるようになります。
   - alembic について、よくわからない方はこちらを参考にしてください。-> [STARUP エンジニア研修/マイグレーション](https://www.notion.so/Alembic-2724f9d8971781b6a9e9d35c07f91221?source=copy_link)
4. 次に、本番環境あるいはローカル環境の実際の DB にこれらの記述を反映させます。

- ローカル環境（docker 上で DB を立ち上げる場合）

  1. 下の make コマンドを使用して、「差分検出->マイグレーションファイル作成」を行います。

  - ```bash
    make db-migrate msg='hogehoge message'
    ```

  2. 作成されたマイグレーションファイルを必ず目視で確認します。（多くのケースで手動での修正が必要です！）
  3. 次の make コマンドを実行して、マイグレーションを反映させます。

  - ```bash
    make db-upgrade
    ```
  - **マイグレーション作成者以外のメンバーについて**
    - docker-compose.yml に`migrator`というサービスを定義していて、これが docker 起動時に自動で`make db-upgrade`に相当するコマンドを打ってくれます。
    - こうすることで、開発チーム全体のマイグレーション履歴が特に意識しなくても揃うようになります。

- 本番環境 (AWS など)
  - 上記のローカル環境でのステップに加えて少しだけ注意する必要があります。
  - 基本的には自動デプロイ workflow 内で適切に**DB の接続先を本番環境に書き換える**という処理を記述していれば問題ないです。テンプレート参考にしてください。
  - 一点、注意としては、デプロイしている DB のスペックによってはローカル環境よりも I/O 処理が極端に遅く、マイグレーションに無限に時間がかかることがあるので、N+1 問題等には気をつけてください。

---

## API について

- API 設計が完了後、[BACKEND_ARCHITECTURE.md](./docs/BACKEND_ARCHITECTURE.md)に沿って、適切に実装していきます
- `POST /login`などのエンドポイントは実装済みですが、もっと色々な実装例をみたい場合は相談してください。

### API ドキュメントについて

- main ブランチに push 時（merge 時）に`app/presentation/`内に変更があった場合、自動で swagger UI で API ドキュメントを作成するようになっています。
- 実装: `.github/workflows/update-swagger.yml`
- 出力場所: `backend/documents/api/`

---

## 実装済み機能について

### 1. 大まかなディレクトリ構造

- オニオンアーキテクチャ用のディレクトリ構造をあらかじめ作成しています
- 今後これに沿って開発をスタートしてください。

### 2. ログイン機能

- API については下記の 3 つを実装しています。
  - POST /api/auth/login
    - `login_id = admin`
    - `password = pass`
      でログインできます。
    - `access_token`については、RSA を使用した暗号方式で生成するようにしています。
    - `backend/app/infrastructure/security/security_service_impl.py`に書いている User スキーマは適切な場所・フィールドに変更して再度実装してください。また、トークンに含める情報も必要に応じて変更してください。
    - 生成したトークンは cookie にバックエンドでセットしています。
  - POST /api/auth/logout
    - 標準的なログアウト機能で、クッキーを削除しています。
  - GET /api/auth/status
    - 依存注入で`current_user`が取得できていれば認証は完了している。

### 3. alembic のセットアップ

- マイグレーションファイル自体はまだ何も作成していませんが、初期セットアップは完了しています。
- 今後は`infrastructure/db/models/`以下に定義したモデルを`make db-migrate msg='hoge'`のようなコマンドを使用し、マイグレーションファイル作成->DB に反映という流れで開発していくことになると思います。
- 特にチーム開発で複数人が同時並行でマイグレーションファイルを作成すると、revision がコンフリクトを起こすことがあります。
  - マージすることで解消もできますが、基本的にはチームでコミュニケーション取りながら、バージョン履歴が一直線にしていく方が開発しやすいと思います。

### 4. ビルドチェック・フォーマットチェックの CI/CD

- デフォルトでは、main ブランチに PR 作成時に、`.github/workflows/backend-ci.yml`に記述されているビルドチェック・フォーマットチェックの CI が回るようになります。少しめんどくさいとは思いますが、毎回 CI をしっかりと通しておくことで、意図しないバグ・エラーが確実に減ります。
- PR 作成前に make コマンドを使用して、ローカルで CI が通るか確認することをお勧めします。
- 細かい Ruff の設定などは、プロジェクトに合わせて変更してください。
