# Ghoona Camp - Database Design

## Overview
朝活コミュニティアプリケーションのデータベース設計書です。
PostgreSQL 15（開発環境: Docker、本番環境: RDS/Aurora）を使用し、Discord連携による参加ログ管理を中心とした設計となっています。

### 技術スタック
- **RDBMS**: PostgreSQL 15
- **ORM**: SQLAlchemy
- **マイグレーション**: Alembic
- **認証**: JWT (RS256) + Cookie-based認証

## Domain-Based Table Design

### User Management
ユーザー認証・プロフィール管理のドメイン

#### users (ユーザー基本情報)
JWT認証によるユーザー基本情報を管理

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PRIMARY KEY | ユーザーID |
| email | VARCHAR(255) | UNIQUE NOT NULL | メールアドレス |
| password_hash | VARCHAR(255) | NOT NULL | パスワードハッシュ (bcrypt) |
| username | VARCHAR(100) | | ユーザー名 |
| avatar_url | TEXT | | アバター画像URL |
| discord_id | VARCHAR(255) | UNIQUE | Discord User ID (連携時) |
| is_active | BOOLEAN | DEFAULT true | アカウント有効状態 |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 更新日時 |

**認証方式:**
- パスワードは bcrypt でハッシュ化して保存
- 認証成功時に JWT (RS256) を発行し、httpOnly Cookie に設定

**実装時の変更点（テンプレートからの修正）:**
テンプレートの `backend/app/domain/entities/user.py` を以下のように修正する必要があります：

| テンプレート実装 | Ghoona Camp 要件 |
|-----------------|------------------|
| `id: int` | `id: UUID` |
| `login_id: str` | `email: str`（ログインIDとして使用） |
| `password: str` | `password_hash: str` |
| `name: str \| None` | `username: str \| None` |
| - | `avatar_url: str \| None` 追加 |
| - | `discord_id: str \| None` 追加 |
| - | `is_active: bool` 追加 |
| - | `created_at`, `updated_at` 追加 |

#### user_metadata (ユーザー詳細情報)
プロフィール設定で入力する詳細情報

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PRIMARY KEY | メタデータID |
| user_id | UUID | REFERENCES users(id), UNIQUE | ユーザーID (外部キー) |
| display_name | VARCHAR(100) | | 表示名 |
| tagline | VARCHAR(150) | | 一言プロフィール |
| bio | TEXT | | 自己紹介文章 |
| skills | TEXT[] | | スキル (配列) |
| interests | TEXT[] | | 興味・関心 (配列) |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 更新日時 |

#### user_visions (ユーザービジョン)
ユーザーのビジョン・将来の目標を管理

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PRIMARY KEY | ビジョンID |
| user_id | UUID | REFERENCES users(id), UNIQUE | ユーザーID (外部キー) |
| vision | TEXT | | ビジョン・将来の目標 |
| is_public | BOOLEAN | DEFAULT false | ビジョンの公開設定 |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 更新日時 |

#### user_social_links (外部リンク)
ユーザーのSNSアカウント・ウェブサイト等の外部リンクを管理

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PRIMARY KEY | リンクID |
| user_id | UUID | REFERENCES users(id) | ユーザーID (外部キー) |
| platform | VARCHAR(50) | NOT NULL | プラットフォーム (twitter, instagram, github, website, blog, etc.) |
| url | TEXT | NOT NULL | リンクURL |
| title | VARCHAR(100) | | リンクのタイトル・説明 |
| is_public | BOOLEAN | DEFAULT true | 公開設定 |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 更新日時 |


#### user_rivals (ライバル関係)
ユーザーが設定するライバル関係を管理

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PRIMARY KEY | 関係ID |
| user_id | UUID | REFERENCES users(id) | ユーザーID (外部キー) |
| rival_user_id | UUID | REFERENCES users(id) | ライバルのユーザーID (外部キー) |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 設定日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 更新日時 |

**制約:**
- UNIQUE(user_id, rival_user_id) - 同一ライバルの重複登録を防ぐ
- CHECK(user_id != rival_user_id) - 自分自身をライバルに設定不可
- ユーザー1人につき最大3人まで（アプリ側で制御）

### Goal Management
ユーザーの目標設定・管理のドメイン

#### goals (目標管理)
ユーザーが設定する目標を管理

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PRIMARY KEY | 目標ID |
| user_id | UUID | REFERENCES users(id) | ユーザーID (外部キー) |
| title | VARCHAR(200) | NOT NULL | 目標タイトル |
| description | TEXT | | 目標詳細 |
| started_at | DATE | DEFAULT CURRENT_DATE | 目標開始日 |
| ended_at | DATE | | 目標終了日 |
| is_active | BOOLEAN | DEFAULT true | 目標の有効状態 |
| is_public | BOOLEAN | DEFAULT false | 外部公開設定 |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 更新日時 |

### Event Management
朝活イベント・参加者管理のドメイン

#### events (朝活イベント)
ユーザーが自由に設定できる朝活イベント

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PRIMARY KEY | イベントID |
| creator_id | UUID | REFERENCES users(id) | 作成者ID (外部キー) |
| title | VARCHAR(200) | NOT NULL | イベント名 |
| description | TEXT | | イベント詳細 |
| event_type | VARCHAR(50) | DEFAULT 'general' | イベントタイプ (study, exercise, meditation, etc.) |
| scheduled_date | DATE | NOT NULL | 開催日 |
| start_time | TIME | NOT NULL | 開始時間 |
| end_time | TIME | NOT NULL | 終了時間 |
| max_participants | INTEGER | | 最大参加者数 |
| is_recurring | BOOLEAN | DEFAULT false | 定期開催かどうか |
| recurrence_pattern | VARCHAR(50) | | 繰り返しパターン (daily, weekly, etc.) |
| discord_channel_id | VARCHAR(255) | | 対応するDiscordチャンネルID |
| is_active | BOOLEAN | DEFAULT true | イベント有効状態 |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 更新日時 |

#### event_participants (イベント参加者)
イベントへの参加者を管理（参加登録・キャンセル可能）

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PRIMARY KEY | 参加ID |
| event_id | UUID | REFERENCES events(id) | イベントID (外部キー) |
| user_id | UUID | REFERENCES users(id) | 参加者ID (外部キー) |
| status | VARCHAR(20) | DEFAULT 'registered' | 参加状態 (registered, cancelled) |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 登録日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 更新日時 |


### Title Management
称号・バッジ・実績管理のドメイン

#### titles (称号マスター)
システムで定義される称号の基本情報

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PRIMARY KEY | 称号ID |
| level | INTEGER | UNIQUE NOT NULL | レベル (1-8) |
| name_jp | VARCHAR(50) | NOT NULL | 日本語名 (例: まどろみ見習い) |
| name_en | VARCHAR(50) | NOT NULL | 英語名 (例: Sleeper) |
| description | TEXT | NOT NULL | 称号の説明・ストーリー |
| required_days | INTEGER | NOT NULL | 獲得に必要な参加日数 |
| image_url | TEXT | | 称号カード画像URL |
| color_theme | VARCHAR(50) | | テーマカラー |
| is_active | BOOLEAN | DEFAULT true | 称号の有効状態 |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 更新日時 |

#### title_achievements (称号実績)
ユーザーが獲得した称号を管理

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PRIMARY KEY | 実績ID |
| user_id | UUID | REFERENCES users(id) | ユーザーID (外部キー) |
| title_id | UUID | REFERENCES titles(id) | 称号ID (外部キー) |
| achieved_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 獲得日時 |
| is_current | BOOLEAN | DEFAULT false | 現在設定中の称号かどうか |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 更新日時 |

### Attendance Management
Discord参加ログ・実際の朝活参加記録のドメイン

#### attendance_logs (参加ログ) ※スコープ外
Discordでの朝活参加記録を管理

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PRIMARY KEY | ログID |
| user_id | UUID | REFERENCES users(id) | ユーザーID (外部キー) |
| event_id | UUID | REFERENCES events(id) | 関連イベントID (外部キー、NULL可) |
| discord_channel_id | VARCHAR(255) | NOT NULL | 参加したDiscordチャンネルID |
| joined_at | TIMESTAMP WITH TIME ZONE | NOT NULL | Discord参加開始時刻 |
| left_at | TIMESTAMP WITH TIME ZONE | | Discord退出時刻 |
| duration_minutes | INTEGER | | 参加時間(分) |
| is_valid | BOOLEAN | DEFAULT true | 有効な参加かどうか（最低時間チェック等） |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 記録作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 更新日時 |

#### attendance_summaries (参加サマリー)
ユーザーの日単位の朝活参加サマリー

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PRIMARY KEY | サマリーID |
| user_id | UUID | REFERENCES users(id) | ユーザーID (外部キー) |
| date | DATE | NOT NULL | 参加日 |
| total_duration_minutes | INTEGER | DEFAULT 0 | 1日の総参加時間(分) |
| session_count | INTEGER | DEFAULT 0 | 参加セッション数 |
| first_join_time | TIME | | 最初の参加時刻 |
| last_leave_time | TIME | | 最後の退出時刻 |
| is_morning_active | BOOLEAN | DEFAULT false | 朝活時間帯(6-7時)の参加有無 |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 更新日時 |

#### attendance_statistics (参加統計)
ユーザーの参加統計情報を管理

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PRIMARY KEY | 統計ID |
| user_id | UUID | REFERENCES users(id), UNIQUE | ユーザーID (外部キー) |
| total_attendance_days | INTEGER | DEFAULT 0 | 総参加日数 |
| current_streak_days | INTEGER | DEFAULT 0 | 現在の連続参加日数 |
| max_streak_days | INTEGER | DEFAULT 0 | 最大連続参加日数 |
| last_attendance_date | DATE | | 最後の参加日 |
| first_attendance_date | DATE | | 初回参加日 |
| total_duration_minutes | INTEGER | DEFAULT 0 | 総参加時間(分) |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 更新日時 |






### Notification Management
通知・リマインダー管理のドメイン

#### notifications (通知)
ユーザーへの通知を管理

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PRIMARY KEY | 通知ID |
| user_id | UUID | REFERENCES users(id) | 通知対象ユーザーID (外部キー) |
| type | VARCHAR(50) | NOT NULL | 通知タイプ (achievement, reminder, rival_update, event) |
| title | VARCHAR(100) | NOT NULL | 通知タイトル |
| message | TEXT | NOT NULL | 通知メッセージ |
| data | JSONB | | 関連データ (称号ID、イベントIDなど) |
| is_read | BOOLEAN | DEFAULT false | 既読状態 |
| scheduled_at | TIMESTAMP WITH TIME ZONE | | 送信予定時刻 (NULL=即座送信) |
| sent_at | TIMESTAMP WITH TIME ZONE | | 実際の送信時刻 |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 更新日時 |

#### notification_settings (通知設定)
ユーザーの通知設定を管理

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PRIMARY KEY | 設定ID |
| user_id | UUID | REFERENCES users(id), UNIQUE | ユーザーID (外部キー) |
| achievement_enabled | BOOLEAN | DEFAULT true | 称号獲得通知の有効/無効 |
| reminder_enabled | BOOLEAN | DEFAULT true | リマインダー通知の有効/無効 |
| rival_update_enabled | BOOLEAN | DEFAULT true | ライバル更新通知の有効/無効 |
| event_reminder_enabled | BOOLEAN | DEFAULT true | イベントリマインダーの有効/無効 |
| reminder_time | TIME | DEFAULT '21:00' | リマインダー送信時刻 |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT NOW() | 更新日時 |

**通知タイプ:**
- `achievement`: 称号獲得
- `reminder`: 朝活リマインダー
- `rival_update`: ライバルの進捗更新
- `event`: イベント関連

## Discussion Points

次に実装するドメインについて議論しましょう：

1. **Attendance Management**の詳細設計
2. **Notification Management**の必要性と範囲
